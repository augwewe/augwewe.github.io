<template><div><h2 id="异步协程" tabindex="-1"><a class="header-anchor" href="#异步协程" aria-hidden="true">#</a> 异步协程</h2>
<p>如下所示，爬取若干个url,消耗的时间是每个url所需的时间之和。</p>
<div class="language-python line-numbers-mode" data-ext="py"><pre v-pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">crawl_page</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"crawling{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sleep_time<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>sleep_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"OK{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
        crawl_page<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

<span class="token operator">%</span>time main<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"url_1"</span><span class="token punctuation">,</span><span class="token string">"url_2"</span><span class="token punctuation">,</span><span class="token string">"url_3"</span><span class="token punctuation">,</span><span class="token string">"url_4"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
输出<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
OKurl_1
crawlingurl_2
OKurl_2
crawlingurl_3
OKurl_3
crawlingurl_4
OKurl_4
CPU times<span class="token punctuation">:</span> total<span class="token punctuation">:</span> <span class="token number">0</span> ns
Wall time<span class="token punctuation">:</span> <span class="token number">10</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>协程,将时间最久的一个任务挂起，在这个时间段内执行其他任务。最终总时间只是其中一个任务所需的最长时间。</p>
<div class="language-python line-numbers-mode" data-ext="py"><pre v-pre class="language-python"><code><span class="token keyword">import</span> asyncio<span class="token punctuation">,</span>time

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">crawl_page</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"crawling{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sleep_time<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>sleep_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"OK {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tasks<span class="token operator">=</span><span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>crawl_page<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">]</span>
    <span class="token keyword">for</span> task <span class="token keyword">in</span> tasks<span class="token punctuation">:</span>
        <span class="token keyword">await</span> task

start_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> main<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"url_1"</span><span class="token punctuation">,</span><span class="token string">"url_2"</span><span class="token punctuation">,</span><span class="token string">"url_3"</span><span class="token punctuation">,</span><span class="token string">"url_6"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start_time<span class="token punctuation">)</span>
输出<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
crawlingurl_1
crawlingurl_2
crawlingurl_3
crawlingurl_6
OK url_1
OK url_2
OK url_3
OK url_6
<span class="token number">6.00509238243103</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="执行task的另一种方法" tabindex="-1"><a class="header-anchor" href="#执行task的另一种方法" aria-hidden="true">#</a> 执行task的另一种方法</h3>
<div class="language-python line-numbers-mode" data-ext="py"><pre v-pre class="language-python"><code><span class="token keyword">import</span> asyncio<span class="token punctuation">,</span>time

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">crawl_page</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"crawling{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sleep_time<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>sleep_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"OK {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tasks<span class="token operator">=</span><span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>crawl_page<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">]</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span> <span class="token comment">#(*task 解包列表)</span>

start_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> main<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"url_1"</span><span class="token punctuation">,</span><span class="token string">"url_2"</span><span class="token punctuation">,</span><span class="token string">"url_3"</span><span class="token punctuation">,</span><span class="token string">"url_4"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start_time<span class="token punctuation">)</span>
输出<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
crawlingurl_1
crawlingurl_2
crawlingurl_3
crawlingurl_4
OK url_1
OK url_2
OK url_3
OK url_4
<span class="token number">4.005146741867065</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="解包列表" tabindex="-1"><a class="header-anchor" href="#解包列表" aria-hidden="true">#</a> 解包列表？</h3>
<p>将列表中的元素都当作参数传到函数里</p>
<img src="@source/Blog/2022/Gra/AotherWay.assets/image-20230130101533387.png" alt="image-20230130101533387" style="zoom: 67%;" />
<img src="@source/Blog/2022/Gra/AotherWay.assets/image-20230130102459988.png" alt="image-20230130102459988" style="zoom: 67%;" />
<img src="@source/Blog/2022/Gra/AotherWay.assets/image-20230130103858779.png" alt="image-20230130103858779" style="zoom:67%;" />
<h3 id="实战-豆瓣电影" tabindex="-1"><a class="header-anchor" href="#实战-豆瓣电影" aria-hidden="true">#</a> 实战：豆瓣电影</h3>
<p>版本1</p>
<div class="language-python line-numbers-mode" data-ext="py"><pre v-pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"User-Agent"</span><span class="token punctuation">:</span><span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36"</span><span class="token punctuation">}</span>

    url <span class="token operator">=</span> <span class="token string">"https://movie.douban.com/cinema/later/beijing/"</span>
    init_page <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
    init_soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>init_page<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>

    all_movies <span class="token operator">=</span> init_soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"showing-soon"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> each_movie <span class="token keyword">in</span> all_movies<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"item"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        all_a_tag <span class="token operator">=</span> each_movie<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
        all_li_tag <span class="token operator">=</span> each_movie<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>

        movie_name <span class="token operator">=</span> all_a_tag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text
        url_to_fetch <span class="token operator">=</span> all_a_tag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span>
        movie_date <span class="token operator">=</span> all_li_tag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text

        response_item <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url_to_fetch<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>content
        soup_item <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>response_item<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>
        img_tag <span class="token operator">=</span> soup_item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{} {} {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>movie_name<span class="token punctuation">,</span> movie_date<span class="token punctuation">,</span> img_tag<span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token operator">%</span>time main<span class="token punctuation">(</span><span class="token punctuation">)</span>
输出<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
风再起时 <span class="token number">02</span>月<span class="token number">05</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2887039584<span class="token punctuation">.</span>jpg
黑豹<span class="token number">2</span> <span class="token number">02</span>月<span class="token number">07</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886589774<span class="token punctuation">.</span>jpg
不能流泪的悲伤 <span class="token number">02</span>月<span class="token number">14</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886531289<span class="token punctuation">.</span>jpg
蚁人与黄蜂女：量子狂潮 <span class="token number">02</span>月<span class="token number">17</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886589789<span class="token punctuation">.</span>jpg
中国乒乓之绝地反击 <span class="token number">02</span>月<span class="token number">17</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2887100255<span class="token punctuation">.</span>jpg
印式英语 <span class="token number">02</span>月<span class="token number">24</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886633470<span class="token punctuation">.</span>jpg
毒舌律师 <span class="token number">02</span>月<span class="token number">24</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886619074<span class="token punctuation">.</span>jpg
会考试的猛犸象 <span class="token number">02</span>月<span class="token number">24</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2879572685<span class="token punctuation">.</span>jpg
拨浪鼓咚咚响 <span class="token number">02</span>月<span class="token number">25</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img2<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886538033<span class="token punctuation">.</span>jpg
宇宙探索编辑部 <span class="token number">04</span>月<span class="token number">01</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886529968<span class="token punctuation">.</span>jpg
龙马精神 <span class="token number">04</span>月<span class="token number">07</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img2<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2887204283<span class="token punctuation">.</span>jpg
长空之王 <span class="token number">04</span>月<span class="token number">28</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886235064<span class="token punctuation">.</span>jpg
人生路不熟 <span class="token number">04</span>月<span class="token number">28</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2887091779<span class="token punctuation">.</span>jpg
检察风云 <span class="token number">04</span>月<span class="token number">29</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886533208<span class="token punctuation">.</span>jpg
请别相信她 <span class="token number">05</span>月<span class="token number">20</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886540928<span class="token punctuation">.</span>jpg
伟大的胜利 <span class="token number">09</span>月<span class="token number">30</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886621940<span class="token punctuation">.</span>jpg
CPU times<span class="token punctuation">:</span> total<span class="token punctuation">:</span> <span class="token number">672</span> ms
Wall time<span class="token punctuation">:</span> <span class="token number">17.2</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>版本2 协程</p>
<div class="language-python line-numbers-mode" data-ext="py"><pre v-pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aiohttp

<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup

header <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36"</span><span class="token punctuation">}</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch_content</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span>
        headers<span class="token operator">=</span>header<span class="token punctuation">,</span> connector<span class="token operator">=</span>aiohttp<span class="token punctuation">.</span>TCPConnector<span class="token punctuation">(</span>ssl<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"https://movie.douban.com/cinema/later/beijing/"</span>
    init_page <span class="token operator">=</span> <span class="token keyword">await</span> fetch_content<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    init_soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>init_page<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>

    movie_names<span class="token punctuation">,</span> urls_to_fetch<span class="token punctuation">,</span> movie_dates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    all_movies <span class="token operator">=</span> init_soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"showing-soon"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> each_movie <span class="token keyword">in</span> all_movies<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">"item"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        all_a_tag <span class="token operator">=</span> each_movie<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
        all_li_tag <span class="token operator">=</span> each_movie<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>

        movie_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_a_tag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        urls_to_fetch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_a_tag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        movie_dates<span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_li_tag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>

    tasks <span class="token operator">=</span> <span class="token punctuation">[</span>fetch_content<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">for</span> url <span class="token keyword">in</span> urls_to_fetch<span class="token punctuation">]</span>
    pages <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span>

    <span class="token keyword">for</span> movie_name<span class="token punctuation">,</span> movie_date<span class="token punctuation">,</span> page <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>movie_names<span class="token punctuation">,</span> movie_dates<span class="token punctuation">,</span> pages<span class="token punctuation">)</span><span class="token punctuation">:</span>
        soup_item <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>
        img_tag <span class="token operator">=</span> soup_item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{} {} {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>movie_name<span class="token punctuation">,</span> movie_date<span class="token punctuation">,</span> img_tag<span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
输出<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
风再起时 <span class="token number">02</span>月<span class="token number">05</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2887039584<span class="token punctuation">.</span>jpg
黑豹<span class="token number">2</span> <span class="token number">02</span>月<span class="token number">07</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886589774<span class="token punctuation">.</span>jpg
不能流泪的悲伤 <span class="token number">02</span>月<span class="token number">14</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886531289<span class="token punctuation">.</span>jpg
蚁人与黄蜂女：量子狂潮 <span class="token number">02</span>月<span class="token number">17</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886589789<span class="token punctuation">.</span>jpg
中国乒乓之绝地反击 <span class="token number">02</span>月<span class="token number">17</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2887100255<span class="token punctuation">.</span>jpg
印式英语 <span class="token number">02</span>月<span class="token number">24</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886633470<span class="token punctuation">.</span>jpg
毒舌律师 <span class="token number">02</span>月<span class="token number">24</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886619074<span class="token punctuation">.</span>jpg
会考试的猛犸象 <span class="token number">02</span>月<span class="token number">24</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2879572685<span class="token punctuation">.</span>jpg
拨浪鼓咚咚响 <span class="token number">02</span>月<span class="token number">25</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img2<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886538033<span class="token punctuation">.</span>jpg
宇宙探索编辑部 <span class="token number">04</span>月<span class="token number">01</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886529968<span class="token punctuation">.</span>jpg
龙马精神 <span class="token number">04</span>月<span class="token number">07</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img2<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2887204283<span class="token punctuation">.</span>jpg
长空之王 <span class="token number">04</span>月<span class="token number">28</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img9<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886235064<span class="token punctuation">.</span>jpg
人生路不熟 <span class="token number">04</span>月<span class="token number">28</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2887091779<span class="token punctuation">.</span>jpg
检察风云 <span class="token number">04</span>月<span class="token number">29</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886533208<span class="token punctuation">.</span>jpg
请别相信她 <span class="token number">05</span>月<span class="token number">20</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886540928<span class="token punctuation">.</span>jpg
伟大的胜利 <span class="token number">09</span>月<span class="token number">30</span>日 https<span class="token punctuation">:</span><span class="token operator">//</span>img1<span class="token punctuation">.</span>doubanio<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>photo<span class="token operator">/</span>s_ratio_poster<span class="token operator">/</span>public<span class="token operator">/</span>p2886621940<span class="token punctuation">.</span>jpg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div></template>


